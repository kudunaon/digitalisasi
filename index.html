<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WUSTER DASHBOARD - Dual Broker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-height {
            min-height: 200px; /* Set a consistent height for all cards */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .data-value {
            font-size: 2rem;
            font-weight: bold;
            color: #d1d5db;
        }
        .chart-container {
            flex-grow: 1; /* Allows chart to take up available space */
            position: relative;
            padding-bottom: 20px; /* Space for the chart's content */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold tracking-wide text-white">WUSTER DASHBOARD</h1>
            <p class="text-lg text-gray-400">Data from Multiple Brokers</p>
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <div class="flex items-center">
                    <span class="inline-block w-3 h-3 rounded-full bg-red-500" id="emqx-status-indicator"></span>
                    <span class="text-sm font-semibold ml-2 text-red-500" id="emqx-status-text">EMQX: Disconnected</span>
                </div>
                <div class="flex items-center">
                    <span class="inline-block w-3 h-3 rounded-full bg-red-500" id="hivemq-status-indicator"></span>
                    <span class="text-sm font-semibold ml-2 text-red-500" id="hivemq-status-text">HiveMQ: Disconnected</span>
                </div>
            </div>
        </header>

        <div class="flex flex-wrap -mx-2">

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Loading Isi</h5>
                    <div class="data-value text-blue-400"><span id="value-1">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Topic: `loading/isi`</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Air PAM</h5>
                    <div class="data-value text-blue-400"><span id="value-2">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Topic: `flowMeter/volum`</div>
                </div>
            </div>

            <div class="w-full md:w-2/3 lg:w-2/3 px-2 mb-4">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col wide-card hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-2xl font-bold mb-2 text-gray-300">Over Flow</h5>
                    <div class="chart-container">
                        <canvas id="flowRateChart"></canvas>
                    </div>
                    <div class="text-sm mt-2 text-gray-500">Flow Rate from `flowMeter/volum` (L/min)</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Loading Jarak</h5>
                    <div class="data-value text-blue-400"><span id="value-4">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Topic: `loading/kosong`</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Listrik</h5>
                    <div class="data-value text-blue-400"><span id="value-5">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">KWH</div>
                </div>
            </div>

            <div class="w-full md:w-2/3 lg:w-2/3 px-2 mb-4">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col justify-between wide-card hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-2xl font-bold mb-2 text-gray-300">Daya Aktif</h5>
                    <div class="chart-container">
                        <canvas id="currentChart"></canvas>
                    </div>
                    <div class="text-sm mt-2 text-gray-500">Current from `modbus/r_current` (A)</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Unload Hanger</h5>
                    <div class="data-value text-blue-400"><span id="value-7">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Topic: `unloading/isi`</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">DI Water</h5>
                    <div class="data-value text-blue-400"><span id="value-8">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Liter</div>
                </div>
            </div>

            <div class="w-full md:w-2/3 lg:w-2/3 px-2 mb-4">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col justify-between wide-card hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-2xl font-bold mb-2 text-gray-300">Over Flow</h5>
                    <div class="data-value text-green-400"><span id="value-9">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Liter/Min</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Unload Jarak</h5>
                    <div class="data-value text-blue-400"><span id="value-10">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Topic: `unloading/kosong`</div>
                </div>
            </div>

            <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/6 px-2 mb-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg h-full flex flex-col justify-between hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-xl font-bold mb-2 text-gray-300">Pressure Angin</h5>
                    <div class="data-value text-blue-400"><span id="value-11">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Bar</div>
                </div>
            </div>

            <div class="w-full md:w-2/3 lg:w-2/3 px-2 mb-4">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col justify-between wide-card hover:shadow-2xl transition-shadow duration-300 card-height">
                    <h5 class="text-2xl font-bold mb-2 text-gray-300">Pressure History</h5>
                    <div class="data-value text-green-400"><span id="value-12">--</span></div>
                    <div class="text-sm mt-2 text-gray-500">Bar</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- EMQX BROKER CONFIGURATION ---
        const emqx = {
            host: 'broker.emqx.io',
            port: 8083,
            clientId: 'web-client-emqx-' + parseInt(Math.random() * 100000),
            topics: [
                `loading/isi`,
                `loading/kosong`,
                `unloading/isi`,
                `unloading/kosong`,
                `card/5`,
                `card/6`,
                `card/8`,
                `card/9`,
                `card/11`,
                `card/12`
            ],
            statusIndicator: document.getElementById('emqx-status-indicator'),
            statusText: document.getElementById('emqx-status-text')
        };
        const clientEMQX = new Paho.MQTT.Client(emqx.host, Number(emqx.port), "/mqtt", emqx.clientId);

        // --- HIVEMQ BROKER CONFIGURATION ---
        const hivemq = {
            host: 'broker.hivemq.com',
            port: 8000,
            clientId: 'web-client-hivemq-' + parseInt(Math.random() * 100000),
            topics: [`flowMeter/volum`, `modbus/power_consumption`, `modbus/r_current`],
            statusIndicator: document.getElementById('hivemq-status-indicator'),
            statusText: document.getElementById('hivemq-status-text')
        };
        const clientHiveMQ = new Paho.MQTT.Client(hivemq.host, Number(hivemq.port), "/mqtt", hivemq.clientId);
        
        // --- CHART & DATA LOGIC ---
        const maxDataPoints = 20;

        let flowRateChart;
        let currentChart;
        let previousVolume = null;
        let previousTime = null;
        
        function initializeFlowRateChart() {
            const ctx = document.getElementById('flowRateChart').getContext('2d');
            flowRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Flow Rate (L/min)',
                        data: [],
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#d1d5db'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#d1d5db',
                            bodyColor: '#d1d5db'
                        }
                    }
                }
            });
        }
        
        function initializeCurrentChart() {
            const ctx = document.getElementById('currentChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Current (A)',
                        data: [],
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#d1d5db'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#d1d5db',
                            bodyColor: '#d1d5db'
                        }
                    }
                }
            });
        }


        // --- MESSAGE HANDLING LOGIC ---
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;

            // Handle the flow meter data for both the Air PAM card and the chart
            if (topic === 'flowMeter/volum') {
                // Update Air PAM card with raw volume data
                const valueElement = document.getElementById(`value-2`);
                if (valueElement) {
                    valueElement.textContent = payload;
                }

                // Calculate flow rate and update chart
                const currentVolume = parseFloat(payload);
                const currentTime = Date.now();
                
                if (previousVolume !== null && previousTime !== null) {
                    const timeDifferenceInSeconds = (currentTime - previousTime) / 1000;
                    const volumeDifference = currentVolume - previousVolume;

                    // Calculate flow rate in L/min
                    const flowRate = (volumeDifference / timeDifferenceInSeconds) * 60;
                    
                    flowRateChart.data.labels.push(new Date().toLocaleTimeString());
                    flowRateChart.data.datasets[0].data.push(flowRate);

                    if (flowRateChart.data.labels.length > maxDataPoints) {
                        flowRateChart.data.labels.shift(); // Remove the oldest data point
                        flowRateChart.data.datasets[0].data.shift(); // Remove the oldest data point
                    }

                    flowRateChart.update();
                }
                
                previousVolume = currentVolume;
                previousTime = currentTime;
                return; // Stop further processing for this topic
            }
            
            // Handle other topics
            let cardId;
            switch (topic) {
                case 'loading/isi':
                    cardId = '1';
                    break;
                case 'loading/kosong':
                    cardId = '4';
                    break;
                case 'unloading/isi':
                    cardId = '7';
                    break;
                case 'unloading/kosong':
                    cardId = '10';
                    break;
                case 'card/3':
                    cardId = '3';
                    break;
                case 'modbus/power_consumption':
                    cardId = '5';
                    break;
                case 'modbus/r_current':
                    currentChart.data.labels.push(new Date().toLocaleTimeString());
                    currentChart.data.datasets[0].data.push(parseFloat(payload));

                    if (currentChart.data.labels.length > maxDataPoints) {
                        currentChart.data.labels.shift();
                        currentChart.data.datasets[0].data.shift();
                    }

                    currentChart.update();
                    break;
                case 'card/8':
                    cardId = '8';
                    break;
                case 'card/9':
                    cardId = '9';
                    break;
                case 'card/11':
                    cardId = '11';
                    break;
                case 'card/12':
                    cardId = '12';
                    break;
            }

            if (cardId) {
                const valueElement = document.getElementById(`value-${cardId}`);
                if (valueElement) {
                    valueElement.textContent = payload;
                }
            }
        }

        // --- CONNECTION HANDLERS ---
        function handleConnection(client, config) {
            client.onConnectionLost = (responseObject) => {
                if (responseObject.errorCode !== 0) {
                    console.log(`Connection to ${config.host} lost: ` + responseObject.errorMessage);
                    config.statusIndicator.classList.remove('bg-green-500');
                    config.statusIndicator.classList.add('bg-red-500');
                    config.statusText.textContent = `${config.host === emqx.host ? 'EMQX' : 'HiveMQ'}: Disconnected`;
                    config.statusText.classList.remove('text-green-500');
                    config.statusText.classList.add('text-red-500');
                }
            };

            client.onMessageArrived = onMessageArrived;

            client.connect({
                onSuccess: () => {
                    console.log(`Connected to ${config.host}.`);
                    config.statusIndicator.classList.remove('bg-red-500');
                    config.statusIndicator.classList.add('bg-green-500');
                    config.statusText.textContent = `${config.host === emqx.host ? 'EMQX' : 'HiveMQ'}: Connected`;
                    config.statusText.classList.remove('text-red-500');
                    config.statusText.classList.add('text-green-500');

                    config.topics.forEach(topic => {
                        client.subscribe(topic);
                        console.log(`Subscribed to topic: ${topic} on ${config.host}`);
                    });
                }
            });
        }
        
        window.onload = () => {
            initializeFlowRateChart();
            initializeCurrentChart();
            handleConnection(clientEMQX, emqx);
            handleConnection(clientHiveMQ, hivemq);
        };
    </script>
</body>
</html>